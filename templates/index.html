{% extends "layout.html" %}

{% block content %}
<!-- Panneau de s√©lection (bandeau en haut sur toute la largeur) -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">S√©lection de l'exercice</h5>
                {% if ai_provider == 'gemini' %}
                    <span class="badge bg-info">Gemini</span>
                {% elif ai_provider == 'mistral' %}
                    <span class="badge bg-warning">Mistral</span>
                {% else %}
                    <span class="badge bg-secondary">LocalAI</span>
                {% endif %}
            </div>
            <div class="card-body">
                <form id="exercise-form" class="row g-3">
<div class="col-md-3">
                        <input type="hidden" id="niveau" value="Troisi√®me">
                    </div>
                    
                    <div class="col-md-4">
<label for="theme" class="form-label">Th√®me</label>
                        <select class="form-select" id="theme" required>
                            <option value="" selected disabled>Choisir un th√®me</option>
                            {% for item in data['Troisi√®me'] %}
                            <option value="{{ item['th√®me'] }}">{{ item['th√®me'] }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
<div class="col-md-3">
                        <label class="form-label">Difficult√©</label>
                        <div id="difficulty-stars" class="mb-2">
                            {% for i in range(1,6) %}
                            <i class="bi bi-star-fill star-icon" data-value="{{ i }}"></i>
                            {% endfor %}
                        </div>
                        <input type="hidden" id="difficulte" name="difficulte" value="3" required>
                    </div>
                    
                    <div class="col-md-2 d-flex align-items-end">
                        <button type="submit" class="btn btn-primary w-100" id="generate-btn">Lance ton d√©fi üöÄ</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Panneau d'√©nonc√© (sur toute la largeur) -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">√ânonc√© de l'exercice</h5>
            </div>
            <div class="card-body">
                <div id="exercise-content" class="d-none">
                    <div id="exercise-text" class="mb-4"></div>
                    <div class="text-end">
                        <div class="btn-group">
                            <button id="copy-skeleton-btn" class="btn btn-outline-primary">
                                <i class="bi bi-clipboard"></i> Copier le squelette vers l'√©diteur
                            </button>
                            <form action="{{ url_for('prepare_notebook') }}" method="post" class="d-inline">
                                <button type="submit" class="btn btn-outline-success ms-2">
                                    <i class="bi bi-file-earmark-code"></i> T√©l√©charger en Jupyter Notebook
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
                <div id="loading-exercise" class="d-none text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Chargement...</span>
                    </div>
                    <p class="mt-2">G√©n√©ration de l'√©nonc√© en cours...</p>
                </div>
                <div id="no-exercise" class="text-center">
                    <p class="text-muted">S√©lectionnez un niveau, un th√®me et une difficult√©, puis cliquez sur "G√©n√©rer l'exercice" pour commencer.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- √âditeur de code et √©valuation sur deux colonnes -->
<div class="row">
    <!-- √âditeur de code (colonne gauche) -->
    <div class="col-md-6">
        <div class="card mb-4 d-none" id="code-editor-card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">√âditeur de code</h5>
            </div>
            <div class="card-body">
                <textarea id="code-editor" class="form-control" rows="15"></textarea>
                <div class="d-flex justify-content-between mt-3">
                    <button class="btn btn-primary" id="run-code-btn">Ex√©cuter le code</button>
                    <button class="btn btn-success" id="evaluate-code-btn">√âvaluer le code</button>
                </div>
            </div>
        </div>
        
        <!-- R√©sultat de l'ex√©cution -->
        <div class="card mb-4 d-none" id="execution-result-card">
            <div class="card-header bg-secondary text-white">
                <h5 class="mb-0">R√©sultat de l'ex√©cution</h5>
            </div>
            <div class="card-body">
                <pre id="execution-output" class="bg-dark text-light p-3 rounded"></pre>
            </div>
        </div>
    </div>
    
<!-- √âvaluation du code (colonne droite) -->
    <div class="col-md-6">
        <div class="card mb-4 d-none" id="evaluation-card">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">√âvaluation du code</h5>
            </div>
            <div class="card-body">
                <div id="evaluation-content"></div>
                <div id="loading-evaluation" class="d-none text-center">
                    <div class="spinner-border text-info" role="status">
                        <span class="visually-hidden">Chargement...</span>
                    </div>
                    <p class="mt-2">√âvaluation du code en cours...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Bo√Æte de dialogue pour input() -->
<div class="modal fade" id="inputModal" tabindex="-1" aria-labelledby="inputModalLabel" aria-hidden="true" data-bs-backdrop="static">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="inputModalLabel">Entr√©e requise</h5>
      </div>
      <div class="modal-body">
        <p id="input-prompt">Veuillez entrer une valeur :</p>
        <div class="input-group">
          <input type="text" class="form-control" id="input-value" placeholder="Votre r√©ponse">
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" id="submit-input">Soumettre</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Donn√©es des exercices
    const exerciseData = JSON.parse('{{ data|tojson|safe }}');
    
    // √âl√©ments du DOM
    const niveauSelect = document.getElementById('niveau');
    const themeSelect = document.getElementById('theme');
    const difficulteSelect = document.getElementById('difficulte');
    const generateBtn = document.getElementById('generate-btn');
    const exerciseForm = document.getElementById('exercise-form');
    const exerciseContent = document.getElementById('exercise-content');
    const exerciseText = document.getElementById('exercise-text');
    const loadingExercise = document.getElementById('loading-exercise');
    const noExercise = document.getElementById('no-exercise');
    const codeEditorCard = document.getElementById('code-editor-card');
    const runCodeBtn = document.getElementById('run-code-btn');
    const runWithInputBtn = document.getElementById('run-with-input-btn');
    const evaluateCodeBtn = document.getElementById('evaluate-code-btn');
    const executionResultCard = document.getElementById('execution-result-card');
    const executionOutput = document.getElementById('execution-output');
    const evaluationCard = document.getElementById('evaluation-card');
    const evaluationContent = document.getElementById('evaluation-content');
    const loadingEvaluation = document.getElementById('loading-evaluation');
    const copySkeletonBtn = document.getElementById('copy-skeleton-btn');
    const inputModal = new bootstrap.Modal(document.getElementById('inputModal'));
    const inputPrompt = document.getElementById('input-prompt');
    const inputValue = document.getElementById('input-value');
    const submitInputBtn = document.getElementById('submit-input');
    
    // Initialiser CodeMirror
    let codeEditor;
    document.addEventListener('DOMContentLoaded', function() {
        codeEditor = CodeMirror.fromTextArea(document.getElementById('code-editor'), {
            mode: 'python',
            theme: 'monokai',
            lineNumbers: true,
            indentUnit: 4,
            tabSize: 4,
            indentWithTabs: false,
            lineWrapping: true,
            autofocus: true
        });
    });
    
    // √âv√©nements de s√©lection
    niveauSelect.addEventListener('change', function() {
        const niveau = this.value;
        
        // R√©initialiser les autres s√©lections
        themeSelect.innerHTML = '<option value="" selected disabled>Choisir un th√®me</option>';
        difficulteSelect.innerHTML = '<option value="" selected disabled>Choisir un niveau de difficult√©</option>';
        difficulteSelect.disabled = true;
        generateBtn.disabled = true;
        
        // Remplir les th√®mes disponibles
        if (niveau && exerciseData[niveau]) {
            themeSelect.disabled = false;
            exerciseData[niveau].forEach(theme => {
                const option = document.createElement('option');
                option.value = theme.th√®me;
                option.textContent = theme.th√®me;
                themeSelect.appendChild(option);
            });
        } else {
            themeSelect.disabled = true;
        }
    });
    
    themeSelect.addEventListener('change', function() {
        const theme = this.value;
        if (theme) {
            generateBtn.disabled = false;
        } else {
            generateBtn.disabled = true;
        }
    });
    
    // G√©n√©ration de l'exercice
    exerciseForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const niveau = niveauSelect.value;
        const theme = themeSelect.value;
        const difficulte = parseInt(difficulteSelect.value);
        
        if (!niveau || !theme || !difficulte) {
            alert('Veuillez s√©lectionner tous les champs');
            return;
        }
        
        // Afficher le chargement
        noExercise.classList.add('d-none');
        exerciseContent.classList.add('d-none');
        loadingExercise.classList.remove('d-none');
        codeEditorCard.classList.add('d-none');
        executionResultCard.classList.add('d-none');
        evaluationCard.classList.add('d-none');
        
        // Appel √† l'API pour g√©n√©rer l'exercice
        fetch('/generate-exercise', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                niveau: niveau,
                theme: theme,
                difficulte: difficulte
            })
        })
        .then(response => response.json())
        .then(data => {
            // Masquer le chargement
            loadingExercise.classList.add('d-none');
            
            // Afficher l'√©nonc√©
            exerciseContent.classList.remove('d-none');
            exerciseText.innerHTML = formatExerciseText(data.enonce);
            
            // Afficher l'√©diteur de code
            codeEditorCard.classList.remove('d-none');
            
            // R√©initialiser l'√©diteur de code
            codeEditor.setValue('# √âcrivez votre code ici\n\n');
            
            // Stocker l'√©nonc√© pour l'√©valuation
            codeEditorCard.dataset.enonce = data.enonce;
        })
        .catch(error => {
            console.error('Erreur:', error);
            loadingExercise.classList.add('d-none');
            alert('Une erreur est survenue lors de la g√©n√©ration de l\'exercice.');
        });
    });
    
    // Variables pour l'ex√©cution asynchrone
    let currentExecutionId = null;
    let executionInterval = null;

    // Fonction pour d√©tecter si le code contient des appels √† input()
    function containsInputCall(code) {
        // Recherche de "input(" dans le code, en ignorant les commentaires
        const lines = code.split('\n');
        for (const line of lines) {
            const trimmedLine = line.trim();
            // Ignorer les lignes vides et les commentaires
            if (trimmedLine === '' || trimmedLine.startsWith('#')) {
                continue;
            }
            // V√©rifier si la ligne contient un appel √† input()
            if (trimmedLine.includes('input(')) {
                return true;
            }
        }
        return false;
    }

    // Ex√©cution du code (d√©tecte automatiquement si input() est utilis√©)
    runCodeBtn.addEventListener('click', function() {
        const code = codeEditor.getValue();
        
        if (!code.trim()) {
            alert('Veuillez √©crire du code avant de l\'ex√©cuter');
            return;
        }
        
        // Afficher le r√©sultat
        executionResultCard.classList.remove('d-none');
        executionOutput.innerHTML = '<div class="text-center"><div class="spinner-border text-primary" role="status"></div><p class="mt-2">Ex√©cution en cours...</p></div>';
        
        // D√©tecter si le code contient des appels √† input()
        if (containsInputCall(code)) {
            // Mode asynchrone avec support de input()
            fetch('/start-execution', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    code: code
                })
            })
            .then(response => response.json())
            .then(data => {
                currentExecutionId = data.execution_id;
                
                // D√©marrer la v√©rification p√©riodique de l'√©tat
                executionInterval = setInterval(checkExecutionStatus, 500);
            })
            .catch(error => {
                console.error('Erreur:', error);
                executionOutput.innerHTML = '<span class="text-danger">Erreur lors du d√©marrage de l\'ex√©cution.</span>';
            });
        } else {
            // Mode synchrone standard (sans support de input())
            fetch('/execute-code', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    code: code
                })
            })
            .then(response => response.json())
            .then(data => {
                // Afficher le r√©sultat
                if (data.error) {
                    executionOutput.innerHTML = `<span class="text-danger">${escapeHtml(data.error)}</span>`;
                } else {
                    executionOutput.innerHTML = escapeHtml(data.output) || '<span class="text-muted">Aucune sortie</span>';
                }
            })
            .catch(error => {
                console.error('Erreur:', error);
                executionOutput.innerHTML = '<span class="text-danger">Une erreur est survenue lors de l\'ex√©cution du code.</span>';
            });
        }
    });
    
    // Fonction pour v√©rifier l'√©tat de l'ex√©cution
    function checkExecutionStatus() {
        if (!currentExecutionId) return;
        
        fetch(`/execution-status/${currentExecutionId}`)
            .then(response => response.json())
            .then(data => {
                // Si l'ex√©cution attend une entr√©e
                if (data.input_required) {
                    clearInterval(executionInterval);
                    
                    // Afficher la bo√Æte de dialogue d'entr√©e
                    inputPrompt.textContent = data.input_prompt || 'Veuillez entrer une valeur :';
                    inputValue.value = '';
                    inputModal.show();
                    
                    // Focus sur le champ d'entr√©e
                    setTimeout(() => {
                        inputValue.focus();
                    }, 500);
                }
                // Si l'ex√©cution est termin√©e
                else if (data.status === 'completed' || data.status === 'error') {
                    clearInterval(executionInterval);
                    currentExecutionId = null;
                    
                    // Afficher le r√©sultat
                    if (data.result.error) {
                        executionOutput.innerHTML = `<span class="text-danger">${escapeHtml(data.result.error)}</span>`;
                    } else {
                        executionOutput.innerHTML = escapeHtml(data.result.output) || '<span class="text-muted">Aucune sortie</span>';
                    }
                }
            })
            .catch(error => {
                console.error('Erreur:', error);
                clearInterval(executionInterval);
                currentExecutionId = null;
                executionOutput.innerHTML = '<span class="text-danger">Erreur lors de la v√©rification de l\'√©tat de l\'ex√©cution.</span>';
            });
    }
    
    // Gestionnaire d'√©v√©nement pour la soumission d'entr√©e
    submitInputBtn.addEventListener('click', function() {
        submitInput();
    });
    
    // Gestionnaire d'√©v√©nement pour la touche Entr√©e dans le champ d'entr√©e
    inputValue.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            submitInput();
        }
    });
    
    // Fonction pour soumettre l'entr√©e
    function submitInput() {
        const value = inputValue.value;
        
        // Cacher la bo√Æte de dialogue
        inputModal.hide();
        
        // Envoyer la valeur au serveur
        fetch(`/provide-input/${currentExecutionId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                input: value
            })
        })
        .then(response => response.json())
        .then(data => {
            // Reprendre la v√©rification p√©riodique
            executionInterval = setInterval(checkExecutionStatus, 500);
        })
        .catch(error => {
            console.error('Erreur:', error);
            executionOutput.innerHTML = '<span class="text-danger">Erreur lors de la soumission de l\'entr√©e.</span>';
        });
    }
    
    // √âvaluation du code
    evaluateCodeBtn.addEventListener('click', function() {
        const code = codeEditor.getValue();
        const enonce = codeEditorCard.dataset.enonce;
        
        if (!code.trim()) {
            alert('Veuillez √©crire du code avant de l\'√©valuer');
            return;
        }
        
        // Afficher le chargement
        evaluationCard.classList.remove('d-none');
        evaluationContent.classList.add('d-none');
        loadingEvaluation.classList.remove('d-none');
        
        // Appel √† l'API pour √©valuer le code
        fetch('/evaluate-code', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                code: code,
                enonce: enonce
            })
        })
        .then(response => response.json())
        .then(data => {
            // Masquer le chargement
            loadingEvaluation.classList.add('d-none');
            
            // Afficher l'√©valuation
            evaluationContent.classList.remove('d-none');
            evaluationContent.innerHTML = formatEvaluationText(data.evaluation);
        })
        .catch(error => {
            console.error('Erreur:', error);
            loadingEvaluation.classList.add('d-none');
            alert('Une erreur est survenue lors de l\'√©valuation du code.');
        });
    });
    
    // Copier le squelette de code vers l'√©diteur
    copySkeletonBtn.addEventListener('click', function() {
        // Trouver le bloc de code dans l'√©nonc√©
        const codeBlocks = exerciseText.querySelectorAll('pre code.language-python');
        
        if (codeBlocks.length > 0) {
            // Prendre le premier bloc de code Python trouv√©
            const skeletonCode = codeBlocks[0].textContent;
            
            // Mettre le code dans l'√©diteur
            codeEditor.setValue(skeletonCode);
            
            // Notification de succ√®s
            alert('Le squelette de code a √©t√© copi√© dans l\'√©diteur !');
        } else {
            alert('Aucun squelette de code n\'a √©t√© trouv√© dans l\'√©nonc√©.');
        }
    });
    
    // Fonctions utilitaires
    function formatExerciseText(text) {
        // Le texte est d√©j√† en HTML, nous le retournons tel quel
        return text;
    }
    
    function formatEvaluationText(text) {
        // Le texte est d√©j√† en HTML, nous le retournons tel quel
        return text;
    }
    
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    // Gestion des √©toiles de difficult√©
    const stars = document.querySelectorAll('#difficulty-stars .star-icon');
    const difficulteInput = document.getElementById('difficulte');

    stars.forEach(star => {
        star.addEventListener('mouseenter', () => {
            const val = parseInt(star.dataset.value);
            stars.forEach(s => {
                s.classList.toggle('hovered', parseInt(s.dataset.value) <= val);
            });
        });

        star.addEventListener('mouseleave', () => {
            stars.forEach(s => s.classList.remove('hovered'));
        });

        star.addEventListener('click', () => {
            const val = parseInt(star.dataset.value);
            difficulteInput.value = val;
            stars.forEach(s => {
                s.classList.toggle('selected', parseInt(s.dataset.value) <= val);
            });
        });
    });

</script>
{% endblock %}
